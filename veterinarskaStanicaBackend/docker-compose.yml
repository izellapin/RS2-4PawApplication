# Veterinary Clinic Docker Compose Configuration
# Based on CineVibe project pattern

services:
  # SQL Server Database - Main database for veterinary clinic
  veterinary-sql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: veterinary-sql
    restart: unless-stopped
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrongPassword123!   # ostavi ovako
      - MSSQL_PID=Express
    ports:
      - "1402:1433"
    volumes:
      - veterinary_sql_data:/var/opt/mssql
    networks:
      - veterinary-network
    healthcheck:
      test: ["CMD-SHELL", "grep -q 'SQL Server is now ready for client connections' /var/opt/mssql/log/errorlog"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s


  # Main Veterinary API - Core application
  veterinary-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: veterinary-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5160
      - ConnectionStrings__DefaultConnection=Server=veterinary-sql,1433;Database=4PawDB;User Id=sa;Password=YourStrongPassword123!;TrustServerCertificate=True;ConnectRetryCount=0;
      - JWT__Secret=VetClinicSuperSecretKey2024!12345678901234567890
      - JwtSettings__Issuer=VeterinaryClinic
      - JwtSettings__Audience=VeterinaryClinic
      - EmailSettings__SmtpServer=smtp.gmail.com
      - EmailSettings__SmtpPort=587
      - EmailSettings__Username=izellapin@gmail.com
      - EmailSettings__Password=ctql fvkn vebn psno
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin123
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Enabled=true
    ports:
      - "0.0.0.0:5160:5160"
    volumes:
      - veterinary_uploads:/app/uploads
      - veterinary_assets:/app/Assets
      - veterinary_logs:/app/logs
    networks:
      - veterinary-network
    depends_on:
      veterinary-sql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5160/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s


  # RabbitMQ Message Broker - For async notifications (similar to CineVibe)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: veterinary-rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin123
      - RABBITMQ_DEFAULT_VHOST=/
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI port
    volumes:
      - veterinary_rabbitmq_data:/var/lib/rabbitmq
    networks:
      - veterinary-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Optional: Redis for caching (if you want to add caching later)
  redis:
    image: redis:7-alpine
    container_name: veterinary-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # Different port to avoid conflicts
    volumes:
      - veterinary_redis_data:/data
    networks:
      - veterinary-network
    command: redis-server --appendonly yes

# Persistent volumes for data storage
volumes:
  veterinary_sql_data:
    driver: local
  veterinary_rabbitmq_data:
    driver: local
  veterinary_redis_data:
    driver: local
  veterinary_uploads:
    driver: local
  veterinary_assets:
    driver: local
  veterinary_logs:
    driver: local

# Network for service communication
networks:
  veterinary-network:
    driver: bridge
    name: veterinary-network
